name: MLOps CI/CD Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  schedule:
    - cron: '0 0 * * MON'
  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python 3.9
      uses: actions/setup-python@v4
      with:
        python-version: "3.9"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip

        pip install flake8 pytest httpx fastapi uvicorn scikit-learn pandas boto3 dotenv joblib nltk s3fs pyarrow evidently
        
        if [ -f requirements-test.txt ]; then pip install -r requirements-test.txt; fi

    - name: Lint with flake8
      run: |
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

    - name: Test with pytest
      env:
        AWS_ACCESS_KEY_ID: testing
        AWS_SECRET_ACCESS_KEY: testing
        AWS_SECURITY_TOKEN: testing
        AWS_SESSION_TOKEN: testing
        AWS_REGION: eu-north-1
        S3_BUCKET_NAME: test-bucket
        PYTHONPATH: .
      run: |
        pytest

  trigger-sagemaker:
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"
        
    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: eu-north-1

    - name: Install AWS libs
      run: pip install boto3 pandas evidently scikit-learn

    - name: Check Data Drift
      run: python monitoring/monitor_drift.py

    - name: Trigger SageMaker Pipeline
      env:
        PIPELINE_NAME: "NewsClassificationPipeline"
      run: |
        python -c "
        import boto3
        import os
        import sys

        try:
            client = boto3.client('sagemaker', region_name='eu-north-1')
            response = client.start_pipeline_execution(
                PipelineName=os.getenv('PIPELINE_NAME'),
                PipelineExecutionDescription='Triggered by GitHub Actions'
            )
            print(f'SUCCESS: Pipeline triggered! ARN: {response["PipelineExecutionArn"]}')
        except Exception as e:
            print(f'ERROR: {e}')
        "

    - name: Auto-Deploy Latest Model
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        AWS_REGION: eu-north-1
        AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}
      run: |

        pip install "sagemaker>=2.190.0" boto3 python-dotenv scikit-learn pandas s3fs joblib nltk pyarrow evidently

        BUCKET="incremental-classifier-storage" 

        echo "Looking for model in bucket: $BUCKET"

        LATEST_KEY=$(aws s3api list-objects-v2 --bucket $BUCKET --query "sort_by(Contents[?contains(Key, 'model.tar.gz')], &LastModified)[-1].Key" --output text)
        
        if [ "$LATEST_KEY" == "None" ] || [ -z "$LATEST_KEY" ]; then
          echo "ERROR: No model.tar.gz found in bucket $BUCKET!"
          exit 1
        fi

        echo "Found latest artifact: $LATEST_KEY"
        
        export MODEL_DATA_URL="s3://$BUCKET/$LATEST_KEY"
        
        python pipeline_definitions/deploy_model.py