name: MLOps CI/CD Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python 3.9
      uses: actions/setup-python@v4
      with:
        python-version: "3.9"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        # Явно встановлюємо головні бібліотеки, щоб точно не було помилок
        pip install flake8 pytest httpx fastapi uvicorn scikit-learn pandas boto3 dotenv joblib nltk s3fs pyarrow
        
        # Якщо файл існує - довстановлюємо з нього решту (на майбутнє)
        if [ -f requirements-test.txt ]; then pip install -r requirements-test.txt; fi

    - name: Lint with flake8
      run: |
        # перевірка на грубі помилки
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        # перевірка стилю (не ламає білд, просто попереджає --exit-zero)
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

    - name: Test with pytest
      env:
        AWS_ACCESS_KEY_ID: testing
        AWS_SECRET_ACCESS_KEY: testing
        AWS_SECURITY_TOKEN: testing
        AWS_SESSION_TOKEN: testing
        AWS_REGION: eu-north-1
        S3_BUCKET_NAME: test-bucket
        PYTHONPATH: .
      run: |
        pytest

  trigger-sagemaker:
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v3
    
    # 1. Налаштовуємо Python (ставимо 3.10, щоб не нило про deprecation)
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"
        
    # 2. Офіційний вхід в AWS (це найнадійніший спосіб)
    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: eu-north-1

    - name: Install AWS libs
      run: pip install boto3

    # 3. Запуск із налагодженням
    - name: Trigger SageMaker Pipeline
      env:
        PIPELINE_NAME: "NewsClassificationPipeline"
      run: |
        python -c "
        import boto3
        import os
        import sys

        # ДЕБАГ: Перевіряємо, чи бачить boto3 ключі (не виводимо їх!)
        session = boto3.Session()
        creds = session.get_credentials()
        
        if creds is None:
            print('CRITICAL ERROR: Boto3 could not find credentials!')
            sys.exit(1)
        else:
            print(f'Credentials found via: {creds.method}')
            # access_key замаскований, покажемо тільки чи він не пустий
            if creds.access_key:
                print(f'Access Key loaded (len: {len(creds.access_key)})')
            else:
                print('Access Key is EMPTY!')

        try:
            client = boto3.client('sagemaker', region_name='eu-north-1')
            response = client.start_pipeline_execution(
                PipelineName=os.getenv('PIPELINE_NAME'),
                PipelineExecutionDescription='Triggered by GitHub Actions'
            )
            print(f'SUCCESS: Pipeline triggered! ARN: {response[\"PipelineExecutionArn\"]}')
        except Exception as e:
            print(f'ERROR: {e}')
            # Не падаємо, якщо пайплайну просто не існує, бо нам головне перевірити зв'язок
            # exit(1) 
        "